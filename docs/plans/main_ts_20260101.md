# main.ts 拆分计划

> 目标：将 2064 行的 main.ts 拆分为多个职责单一的模块

## 当前结构分析

| 功能模块 | 行数 | 方法 |
|---------|------|------|
| 生命周期 | ~100 | `onload`, `onunload`, `loadSettings`, `saveSettings` |
| **生成处理** | ~455 | `handleGeneration` (核心方法，最复杂) |
| Ghost Node 管理 | ~165 | `createGhostNode`, `updateGhostNode`, `replaceGhost*` |
| Selection 监听 | ~380 | `registerCanvasSelectionListener`, `captureTextSelectionContext`, `checkCanvasSelection` |
| 图片处理 | ~60 | `saveImageToVault`, `base64ToArrayBuffer` |
| UI 注入 | ~45 | `injectAiButtonToPopupMenu`, `onSparklesButtonClick` |
| Canvas 工具 | ~155 | `registerCanvasUtilities`, getters |
| 节点选择 | ~170 | `selectConnectedNodes`, `createGroupFromSelection`, etc. |
| 图片查看 | ~80 | `openImageInNewWindow`, `copyImageToClipboard`, `convertToPng` |

---

## 拆分方案

```
src/
├── core/
│   ├── generation-handler.ts    # handleGeneration + 相关辅助方法
│   ├── ghost-node-manager.ts    # Ghost Node 创建/更新/替换
│   └── selection-listener.ts    # Canvas Selection 监听
├── canvas/
│   ├── canvas-utils.ts          # Canvas 工具方法
│   ├── node-operations.ts       # 节点操作 (group, new node, select connected)
│   └── image-viewer.ts          # 图片查看/复制
└── main.ts                      # 仅保留生命周期和组件初始化 (~300 行)
```

---

## 详细文件规划

### 1. `src/core/generation-handler.ts` (~500 行)

```typescript
export class GenerationHandler {
    handleGeneration(userPrompt: string, mode: PaletteMode): Promise<void>
    private getNodeModeSystemPrompt(): string
}
```

**依赖：** GhostNodeManager, IntentResolver, ApiManager

---

### 2. `src/core/ghost-node-manager.ts` (~200 行)

```typescript
export class GhostNodeManager {
    createGhostNode(canvas: Canvas, x: number, y: number): CanvasNode
    updateGhostNode(node: CanvasNode, content: string, isError: boolean): void
    replaceGhostWithCanvasData(canvas: Canvas, ghostNode: CanvasNode, data: CanvasData): Promise<void>
    replaceGhostWithImageNode(canvas: Canvas, ghostNode: CanvasNode, file: TFile): void
}
```

---

### 3. `src/core/selection-listener.ts` (~400 行)

```typescript
export class CanvasSelectionListener {
    registerCanvasSelectionListener(): void
    captureTextSelectionContext(updateCache: boolean): SelectionContext | null
    checkCanvasSelection(): void
    private injectAiButtonToPopupMenu(canvas: Canvas): void
    private getSelectionScreenBBox(selection: Set<CanvasNode>): DOMRect | null
    private countNodeTypes(selection: Set<CanvasNode>): {...}
}
```

---

### 4. `src/canvas/node-operations.ts` (~180 行)

```typescript
export function createGroupFromSelection(canvas: Canvas): void
export function createNewNodeAtCenter(canvas: Canvas): void
export function selectConnectedNodes(canvas: Canvas, childOnly: boolean): void
export function getViewportCenter(canvas: Canvas): { x: number; y: number }
```

---

### 5. `src/canvas/image-viewer.ts` (~100 行)

```typescript
export function openImageInNewWindow(app: App, file: TFile, settings: CanvasAISettings): Promise<void>
export function copyImageToClipboard(app: App, file: TFile): Promise<void>
export function convertToPng(blob: Blob): Promise<Blob>
export function getMimeType(ext: string): string
```

---

## 拆分顺序 (由低风险到高风险)

1. ✅ **Phase 1: 工具函数** - `image-viewer.ts`, `node-operations.ts` (已完成)
2. ✅ **Phase 2: Ghost Node** - `ghost-node-manager.ts` (已完成)
3. ⏸️ **Phase 3: Selection** - `selection-listener.ts` (暂缓 - 与 plugin 状态高度耦合)
4. ⏸️ **Phase 4: Generation** - `generation-handler.ts` (暂缓 - 与 plugin 状态高度耦合)

---

## 执行总结 (2026-01-01)

**已完成拆分：**
- `src/canvas/image-viewer.ts` (~105 行)
- `src/canvas/node-operations.ts` (~160 行)
- `src/core/ghost-node-manager.ts` (~220 行)

**main.ts 行数变化：** 2064 → ~1530 行 (减少约 530 行, 25%)

**Phase 3-4 暂缓原因：**
- selection-listener 和 generation-handler 与 plugin 实例状态深度耦合
- 强行拆分需要大量回调/状态传递，增加复杂度但收益有限
- 当前 main.ts 规模已在合理范围内 (< 800 行目标的 2 倍)

---

## 风险评估

| 模块 | 风险 | 原因 |
|-----|------|-----|
| image-viewer | 低 | 纯工具函数，无状态 |
| node-operations | 低 | 纯工具函数 |
| ghost-node-manager | 中 | 与 Canvas 内部 API 交互 |
| selection-listener | 高 | 事件监听，DOM 操作，状态管理 |
| generation-handler | 最高 | 核心业务逻辑，复杂状态流 |

---

## 验证计划

每个 Phase 完成后：
1. `npm run build` 通过
2. `npm run lint` 通过
3. 手动测试核心功能

---

> [!IMPORTANT]
> 建议先完成 Phase 1-2，验证后再继续 Phase 3-4。
