Obsidian Canvas AI åŠ©æ‰‹æ’ä»¶è®¾è®¡æ–‡æ¡£

1. äº§å“æ¦‚è¿°

ç›®æ ‡ï¼šåœ¨ Obsidian Canvas è§†å›¾ä¸­é›†æˆ Gemini AIï¼Œå…è®¸ç”¨æˆ·é€‰ä¸­ç”»å¸ƒä¸­çš„èŠ‚ç‚¹ï¼ˆæ–‡æœ¬ã€å›¾ç‰‡ã€ç¾¤ç»„ï¼‰ä½œä¸ºä¸Šä¸‹æ–‡ï¼Œè¿›è¡Œ AI å¯¹è¯ã€æ–‡æœ¬ç”Ÿæˆæˆ–å›¾åƒç”Ÿæˆï¼Œå¹¶å°†ç»“æœæ— ç¼å›å†™åˆ°ç”»å¸ƒä¸­ã€‚

2. äº¤äº’ä¸ç•Œé¢è®¾è®¡ (UI/UX)

2.1 æ ¸å¿ƒäº¤äº’ï¼šå¤šåŠŸèƒ½æ‚¬æµ®é¢æ¿ (The Floating Palette)

ä¸ºäº†æä¾›ç±»ä¼¼ Photoshop æ’ä»¶çš„é«˜æ•ˆä½“éªŒï¼Œæˆ‘ä»¬æ”¾å¼ƒç®€å•çš„æ¨¡æ€æ¡†ï¼Œè®¾è®¡ä¸€ä¸ªåŠŸèƒ½ä¸°å¯Œçš„ "æ‚¬æµ®é¢æ¿"ã€‚

è§¦å‘æ–¹å¼ï¼šé€‰ä¸­ Canvas èŠ‚ç‚¹åï¼Œç‚¹å‡» "AI Sparkles âœ¨" æŒ‰é’®ï¼Œé¢æ¿åœ¨é¼ æ ‡é™„è¿‘å¼¹å‡ºã€‚

å¸ƒå±€å‚è€ƒï¼šé¡¶éƒ¨ Tab åˆ‡æ¢æ¨¡å¼ï¼Œä¸­é—´ä¸ºè¾“å…¥åŒºä¸é¢„è®¾ï¼Œåº•éƒ¨ä¸ºå‚æ•°ä¸ç”ŸæˆæŒ‰é’®ã€‚

ç•Œé¢åŒºåŸŸåˆ’åˆ†ï¼š

A. é¡¶éƒ¨æ¨¡å¼æ  (Mode Switcher)

[ ğŸ’¬ Chat / Text ]: ç”¨äºæ€»ç»“ã€ç¿»è¯‘ã€æ¶¦è‰²ã€ä»£ç è§£é‡Šï¼ˆå¯¹åº”åœºæ™¯ 2ï¼‰ã€‚

[ ğŸ¨ Generate Image ]: ç”¨äºæ–‡ç”Ÿå›¾ã€å›¾ç”Ÿå›¾ã€å¤šå›¾ç»„åˆç”Ÿå›¾ï¼ˆå¯¹åº”åœºæ™¯ 1ï¼‰ã€‚

B. é¢„è®¾ä¸è¾“å…¥åŒº (Presets & Prompt)

Prompt Presets (ä¸‹æ‹‰èœå•):

æ˜¾ç¤º "Select a preset..."ã€‚

å³ä¾§è·Ÿéšå°æŒ‰é’®ç»„ï¼š[Save] (ä¿å­˜å½“å‰è¾“å…¥ä¸ºé¢„è®¾), [Manage] (æ‰“å¼€è®¾ç½®é¡µ)ã€‚

äº¤äº’ï¼šé€‰æ‹©é¢„è®¾åï¼Œè‡ªåŠ¨å¡«å……ä¸‹æ–¹çš„æ–‡æœ¬æ¡†ï¼Œç”¨æˆ·å¯ç»§ç»­ä¿®æ”¹ã€‚

Prompt Input (å¤šè¡Œæ–‡æœ¬æ¡†):

æ”¯æŒå¤šè¡Œè¾“å…¥ã€‚

Placeholder éšæ¨¡å¼å˜åŒ–ï¼ˆå¦‚ï¼š"Describe the image..." æˆ– "Ask a question about selected notes..."ï¼‰ã€‚

C. å‚æ•°æ§åˆ¶åŒº (Settings Bar) - ä»…åœ¨ "Generate Image" æ¨¡å¼æ˜¾ç¤º

Aspect Ratio (æ¯”ä¾‹): æä¾›å›¾æ ‡æŒ‰é’®ç»„ [1:1] [16:9] [4:3] [9:16]ã€‚

æ³¨ï¼šGemini Image API é€šå¸¸éœ€è¦é€šè¿‡ Prompt æè¿°å®½é«˜æ¯”ï¼Œæˆ–è€…åç»­ API æ›´æ–°æ”¯æŒå‚æ•°ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ Prompt åè‡ªåŠ¨è¿½åŠ  "in 16:9 aspect ratio" ç­‰åç¼€ã€‚

Style (é£æ ¼): å¯é€‰ä¸‹æ‹‰ [None], [Photorealistic], [Anime], [Sketch].

D. åº•éƒ¨æ“ä½œæ  (Action Footer)

Context Preview: å·¦ä¸‹è§’å°å­—æ˜¾ç¤º "ğŸ”— 3 Nodes Selected (1 Image, 2 Text)"ã€‚

[ Generate ] æŒ‰é’®: å…¨å®½ä¸»æŒ‰é’®ï¼Œç‚¹å‡»å¼€å§‹å¼‚æ­¥ä»»åŠ¡ã€‚

2.2 ä»»åŠ¡åé¦ˆä¸ç»“æœ (Async Feedback)

åŠ è½½çŠ¶æ€: ç‚¹å‡» Generate åï¼Œé¢æ¿è‡ªåŠ¨æ”¶èµ·ï¼Œåœ¨ Canvas ä¸Šç”Ÿæˆ "Ghost Node"ï¼ˆåŠ è½½å ä½ç¬¦ï¼‰ï¼Œæ˜¾ç¤ºå‘¼å¸ç¯åŠ¨ç”»å’Œ "Generating..."ã€‚

ç»“æœå›å†™:

Chat æ¨¡å¼: ç”Ÿæˆ Text Nodeã€‚

Image æ¨¡å¼: ç”Ÿæˆ File Node (å›¾ç‰‡)ã€‚

é”™è¯¯å¤„ç† (Error Handling):

å¦‚æœä»»åŠ¡å¤±è´¥ï¼ˆå¦‚ API æŠ¥é”™ã€ç½‘ç»œè¶…æ—¶ã€Safety Filter æ‹¦æˆªï¼‰ï¼ŒGhost Node å˜ä¸º Error Nodeï¼ˆçº¢è‰²è¾¹æ¡† + âš ï¸ å›¾æ ‡ï¼‰ã€‚

äº¤äº’ï¼šç‚¹å‡» Error Nodeï¼Œå¼¹å‡º Toast æ˜¾ç¤ºå…·ä½“é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚ "Safety filter triggered"ï¼‰ï¼Œå¹¶æä¾› [Retry] æŒ‰é’®é‡æ–°æäº¤ä»»åŠ¡ã€‚

3. æŠ€æœ¯å®ç°æ–¹æ¡ˆ (Technical Architecture)

3.1 éš¾ç‚¹ä¸€ï¼šä¸Šä¸‹æ–‡è·å–ä¸æœ¬åœ°é¢„å¤„ç†

åŒå‰æ–‡ï¼Œåˆ©ç”¨ CanvasConverter å°†é€‰ä¸­çš„èŠ‚ç‚¹è½¬æ¢ä¸º Markdown æˆ– Mermaidï¼Œå¹¶å°†å›¾ç‰‡è½¬æ¢ä¸º Base64ã€‚

3.2 éš¾ç‚¹äºŒï¼šå¤šä»»åŠ¡å¼‚æ­¥å¤„ç†

åŒå‰æ–‡ï¼Œä½¿ç”¨ TaskQueue ç®¡ç†ã€‚

3.3 éš¾ç‚¹ä¸‰ï¼šç»“æœå›å†™

åŒå‰æ–‡ï¼Œæ–‡æœ¬å­˜ Nodeï¼Œå›¾ç‰‡å­˜ Vault æ–‡ä»¶ã€‚

3.4 éš¾ç‚¹å››ï¼šç‰¹å®šåœºæ™¯çš„é«˜çº§å®ç° (New Use Cases)

é’ˆå¯¹æ‚¨æå‡ºçš„ä¸¤ä¸ªç‰¹å®šåœºæ™¯ï¼Œæˆ‘ä»¬éœ€è¦è®¾è®¡ä¸“é—¨çš„å¤„ç†ç®¡çº¿ (Pipeline)ã€‚

åœºæ™¯ 1ï¼šå¤šå›¾ç»„åˆç”Ÿå›¾ (Image Combination / Remix)

ç”¨æˆ·è¡Œä¸ºï¼šé€‰ä¸­ 3 å¼ å‚è€ƒå›¾ï¼ˆå¦‚ï¼šä¸€å¼ æ„å›¾ã€ä¸€å¼ é…è‰²ã€ä¸€å¼ ä¸»ä½“ï¼‰ï¼Œè¾“å…¥ Prompt "Combine these into a cyberpunk city"ã€‚

æŠ€æœ¯æŒ‘æˆ˜ï¼šéœ€è¦æ¨¡å‹åŒæ—¶ç†è§£å¤šå¼ è¾“å…¥å›¾ç‰‡çš„è§†è§‰ç‰¹å¾ï¼Œå¹¶æ ¹æ® Prompt ç”Ÿæˆæ–°å›¾ã€‚
è§£å†³æ–¹æ¡ˆï¼šåˆ©ç”¨ Gemini 3 Pro Image (gemini-3-pro-image-preview) çš„åŸç”Ÿå¤šæ¨¡æ€è¾“å…¥èƒ½åŠ›ã€‚

Direct Image Input (å•æ­¥ç”Ÿæˆ)

è¯¥æ¨¡å‹æ”¯æŒç›´æ¥æ¥å— image (Base64) å’Œ text çš„æ··åˆè¾“å…¥ã€‚

Input: æ„é€ ä¸€ä¸ªåŒ…å« text (ç”¨æˆ· Prompt) å’Œå¤šä¸ª inline_data (é€‰ä¸­çš„å›¾ç‰‡ Base64) çš„ Payloadã€‚

Model Behavior: Gemini 3 ä¼šâ€œçœ‹â€è¿™äº›å›¾ç‰‡ï¼Œç†è§£å…¶æ„å›¾ã€é£æ ¼æˆ–å†…å®¹ï¼Œç„¶åç›´æ¥ç”Ÿæˆç¬¦åˆè¦æ±‚çš„æ–°å›¾ã€‚

ä¼˜åŠ¿: é€Ÿåº¦å¿«ï¼Œä¿ç•™åŸå›¾ç»†èŠ‚èƒ½åŠ›æ›´å¼ºï¼ŒToken æ¶ˆè€—æ¯”â€œè½¬è¯‘æ³•â€æ›´ç›´è§‚ã€‚

åœºæ™¯ 2ï¼šå›¾æ–‡æ··åˆæ€»ç»“ (Multimodal Summarization)

ç”¨æˆ·è¡Œä¸ºï¼šé€‰ä¸­ Canvas ä¸Šçš„ä¸€å †ä¹±ä¸ƒå…«ç³Ÿçš„èŠ‚ç‚¹ï¼ˆæˆªå›¾ã€ç¬”è®°ã€PDF ç‰‡æ®µï¼‰ï¼Œè¾“å…¥ "æ•´ç†æˆä¸€ä»½ç®€æŠ¥"ã€‚

æŠ€æœ¯å®ç°ï¼š

Payload æ„é€ :

ä½¿ç”¨ CanvasConverter.toMarkdown() å°†æ–‡æœ¬èŠ‚ç‚¹æ•´ç†ä¸ºç»“æ„åŒ–æ–‡æœ¬ã€‚

å°†å›¾ç‰‡èŠ‚ç‚¹æå–ä¸º Base64ã€‚

æ„é€  Gemini 1.5 Pro çš„ contents æ•°ç»„ï¼Œäº¤æ›¿æ”¾å…¥ text (Markdown) å’Œ inline_data (Images)ã€‚

System Prompt: "You are a helpful assistant. The user has provided a set of notes and images from a whiteboard canvas. Please summarize them into a coherent report."

3.5 éš¾ç‚¹äº”ï¼šæ™ºèƒ½å¸ƒå±€ä¸èŠ‚ç‚¹å®šä½ (Layout Algorithm)

ä¸ºäº†é˜²æ­¢æ–°ç”Ÿæˆçš„èŠ‚ç‚¹é®æŒ¡ç°æœ‰å†…å®¹ï¼Œéœ€è¦å®ç°ç®€å•çš„é¿è®©ç®—æ³•ã€‚

è®¡ç®—åŒ…å›´ç›’ (Bounding Box):

éå†æ‰€æœ‰é€‰ä¸­èŠ‚ç‚¹ï¼Œè®¡ç®—æ•´ä½“çš„ minX, minY, maxX, maxYã€‚

å®šä½ç­–ç•¥:

é»˜è®¤ä½ç½®: x = maxX + 50 (å³ä¾§ 50px), y = minY (é¡¶éƒ¨å¯¹é½)ã€‚

å°ºå¯¸é¢„è®¾:

Text Node: å®½åº¦å›ºå®š 400pxï¼Œé«˜åº¦è‡ªé€‚åº”ã€‚

Image Node: é»˜è®¤ 500x500px (åç»­æ ¹æ®å›¾ç‰‡æ¯”ä¾‹è°ƒæ•´)ã€‚

ç¢°æ’æ£€æµ‹ (å¯é€‰ä¼˜åŒ–):

æ£€æŸ¥é»˜è®¤ä½ç½®æ˜¯å¦å·²æœ‰å…¶ä»–èŠ‚ç‚¹ã€‚å¦‚æœæœ‰ï¼Œåˆ™å‘ä¸‹åç§» y += 50 ç›´åˆ°æ‰¾åˆ°ç©ºä½ï¼Œæˆ–å‘æ›´å³ä¾§åç§»ã€‚

4. API å‚è€ƒä¸é…ç½®

4.1 Obsidian Plugin API

(ä¿æŒä¸å˜)

4.2 Gemini / OpenRouter API Payload è®¾è®¡

A. ç”Ÿå›¾ Payload (Gemini 3 Pro Image - å¤šæ¨¡æ€è¾“å…¥)

ç°åœ¨æˆ‘ä»¬å¯ä»¥ç›´æ¥å‘é€ Base64 å›¾ç‰‡ç»™ç”Ÿå›¾æ¨¡å‹ï¼š

{
  "model": "google/gemini-3-pro-image-preview",
  "messages": [
    {
      "role": "user",
      "content": [
        {
          "type": "text",
          "text": "Generate a cyberpunk city based on these reference images. --aspect 16:9"
        },
        {
          "type": "image_url",
          "image_url": {
            "url": "data:image/png;base64,iVBORw0KGgo..." // å›¾ç‰‡ 1 Base64
          }
        },
        {
          "type": "image_url",
          "image_url": {
            "url": "data:image/png;base64,abcde1234..." // å›¾ç‰‡ 2 Base64
          }
        }
      ]
    }
  ]
}


æ³¨æ„ï¼šå…·ä½“çš„ JSON å­—æ®µåï¼ˆimage_url vs inline_dataï¼‰å–å†³äºæ‚¨ä½¿ç”¨çš„æ˜¯ OpenRouter æ ‡å‡†æ¥å£è¿˜æ˜¯ Google åŸç”Ÿæ¥å£ã€‚ä¸Šä¾‹ä¸º OpenRouter/OpenAI å…¼å®¹æ ¼å¼ï¼ŒGoogle åŸç”Ÿæ ¼å¼ä½¿ç”¨ parts: [{ inline_data: {...} }]ã€‚

5. æ’ä»¶è®¾ç½®ä¸é…ç½®ç®¡ç† (Settings)

5.1 API Provider é…ç½®

å…è®¸ç”¨æˆ·æ·»åŠ ã€å­˜å‚¨å’Œåˆ‡æ¢å¤šä¸ª API æœåŠ¡å•†ã€‚

æ•°æ®ç»“æ„ (Interface):

interface ApiProvider {
    id: string;
    name: string;        
    providerType: 'gemini' | 'openai' | 'custom';
    baseUrl: string;
    apiKey: string;
    modelName: string;   
    isDefault: boolean;
    safetySettings?: string; // e.g., "BLOCK_NONE" (é’ˆå¯¹ Gemini)
}


5.2 Prompt Preset Manager

(ä¿æŒä¸å˜)

5.3 é€šç”¨è®¾ç½® (General Settings)

Image Output Path (å›¾ç‰‡å­˜æ”¾è·¯å¾„):

é€‰é¡¹: Root (æ ¹ç›®å½•), Current Folder (å½“å‰ Canvas æ‰€åœ¨æ–‡ä»¶å¤¹), Attachment Folder (Obsidian è®¾ç½®çš„é™„ä»¶æ–‡ä»¶å¤¹), Custom (è‡ªå®šä¹‰è·¯å¾„)ã€‚

é»˜è®¤å€¼: Attachment Folderã€‚

Default System Prompt:

ç”¨äº Chat æ¨¡å¼çš„é»˜è®¤ç³»ç»Ÿæç¤ºè¯ã€‚

ç¤ºä¾‹: "You are an expert researcher embedded in a knowledge graph tool. Answer concisely and use Markdown formatting."

6. å¼€å‘è·¯çº¿å›¾å»ºè®®

Phase 1 (Core & UI): æ­å»ºæ‚¬æµ®é¢æ¿ UI (React/Svelte æ¨è)ï¼Œå®ç°åŸºæœ¬çš„ Chat æ¨¡å¼ã€‚

Phase 2 (Settings): å®Œæˆ Providerã€Preset ä»¥åŠ Path Settings ç®¡ç†ã€‚

Phase 3 (Image Pipeline): å®ç° CanvasImageHelper è¯»å–æœ¬åœ°å›¾ç‰‡è½¬ Base64ï¼Œå¹¶å¯¹æ¥ Gemini 3 ç”Ÿå›¾æ¥å£ã€‚

Phase 4 (Canvas Integration): å®Œå–„ Node Placement ç®—æ³•ï¼Œå¤„ç†æ–‡ä»¶ä¿å­˜ä¸é”™è¯¯åé¦ˆã€‚