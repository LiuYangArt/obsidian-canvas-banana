
## 1. äº§å“æ¦‚è¿°

**ç›®æ ‡**ï¼šåœ¨ Obsidian Canvas è§†å›¾ä¸­é›†æˆ Gemini AI (ç‰¹åˆ«æ˜¯ Gemini 3 Pro Image)ï¼Œå…è®¸ç”¨æˆ·é€šè¿‡é€‰ä¸­ç”»å¸ƒä¸­çš„èŠ‚ç‚¹å’Œè¿çº¿æ„å»ºå¤šæ¨¡æ€ä¸Šä¸‹æ–‡ï¼Œè¿›è¡Œ AI å¯¹è¯æˆ–é«˜ç²¾åº¦çš„å›¾åƒç”Ÿæˆ/ç¼–è¾‘ã€‚

**æ ¸å¿ƒä»·å€¼**ï¼š

- **å¤šæ¨¡æ€åŸç”Ÿ**ï¼šä¸ä»…ä»…æ˜¯æ–‡ç”Ÿå›¾ï¼Œè€Œæ˜¯åˆ©ç”¨ Canvas çš„ç©ºé—´ç»“æ„è¿›è¡Œâ€œå›¾ç”Ÿå›¾â€å’Œâ€œæ··åˆç”Ÿå›¾â€ã€‚
    
- **è¯­ä¹‰é“¾æ¥**ï¼šåˆ©ç”¨ Canvas çš„è¿çº¿ï¼ˆEdgesï¼‰ä½œä¸ºè¯­ä¹‰æ¡¥æ¢ï¼Œå‘Šè¯‰ AI å›¾ç‰‡çš„ç”¨é€”ï¼ˆå¦‚ï¼šé£æ ¼å‚è€ƒã€æ„å›¾å‚è€ƒï¼‰ã€‚
    
- **æç®€äº¤äº’**ï¼šæ™ºèƒ½é¢„åˆ¤ç”¨æˆ·æ„å›¾ï¼Œå‡å°‘é‡å¤è¾“å…¥ã€‚
    

## 2. äº¤äº’ä¸ç•Œé¢è®¾è®¡ (UI/UX)

### 2.1 æ ¸å¿ƒäº¤äº’ï¼šå¤šåŠŸèƒ½æ‚¬æµ®é¢æ¿ (The Floating Palette)

æ”¾å¼ƒæ¨¡æ€æ¡†ï¼Œé‡‡ç”¨ç±»ä¼¼ Photoshop çš„**æ‚¬æµ®é¢æ¿**ï¼Œè·Ÿéšé¼ æ ‡æˆ–é€‰ä¸­èŠ‚ç‚¹å‡ºç°ã€‚

- **è§¦å‘æ–¹å¼**ï¼šé€‰ä¸­ Canvas èŠ‚ç‚¹åï¼Œç‚¹å‡» "AI Sparkles âœ¨" æŒ‰é’®ã€‚
    
- **å¸ƒå±€**ï¼šé¡¶éƒ¨ Tab åˆ‡æ¢æ¨¡å¼ï¼Œä¸­é—´ä¸ºè¾“å…¥åŒºï¼Œåº•éƒ¨ä¸ºå‚æ•°ä¸æ“ä½œã€‚
    

#### ç•Œé¢åŒºåŸŸåˆ’åˆ†ï¼š

**A. é¡¶éƒ¨æ¨¡å¼æ  (Mode Switcher)**

- **[ ğŸ’¬ Chat / Text ]**: æ–‡æœ¬ä»»åŠ¡ï¼ˆæ€»ç»“ã€ç¿»è¯‘ã€ä»£ç è§£é‡Šï¼‰ã€‚
    
- **[ ğŸ¨ Generate Image ]**: å›¾åƒä»»åŠ¡ï¼ˆç”Ÿæˆã€ç¼–è¾‘ã€æ··åˆï¼‰ã€‚
    

**B. é¢„è®¾ä¸è¾“å…¥åŒº (Presets & Prompt)**

- **Prompt Input (å¤šè¡Œæ–‡æœ¬æ¡†)**:
    
    - **æ™ºèƒ½å ä½ç¬¦ (Smart Placeholder)**:
        
        - é»˜è®¤: "Enter your prompt here..."
            
        - **[ç‰¹æ€§]** å½“é€‰åŒºåŒ…å«**æ–‡æœ¬èŠ‚ç‚¹**ä¸”è¾“å…¥æ¡†ä¸ºç©ºæ—¶: æ˜¾ç¤º _"Leave empty to use selected text as prompt..."_ (ç°è‰²æ–œä½“)ã€‚
            
    - **è¾“å…¥é€»è¾‘**: ç”¨æˆ·è¾“å…¥ä¼˜å…ˆçº§ > é€‰ä¸­æ–‡æœ¬è‡ªåŠ¨å¡«å……ã€‚
        

**C. å‚æ•°æ§åˆ¶åŒº (Settings Bar)**

- ä»…åœ¨ç”Ÿå›¾æ¨¡å¼æ˜¾ç¤ºï¼š`Aspect Ratio` (1:1, 16:9 ç­‰), `Style` (å†™å®, åŠ¨æ¼«ç­‰)ã€‚
    

**D. åº•éƒ¨æ“ä½œæ  (Action Footer)**

- **Context Preview**: å·¦ä¸‹è§’æ˜¾ç¤ºé€‰åŒºæ‘˜è¦ "ğŸ”— 1 Group (3 images, 2 text)"ã€‚
    
- **[ Generate ] æŒ‰é’®**: æ‰§è¡Œä»»åŠ¡ã€‚
    

### 2.2 ä»»åŠ¡åé¦ˆä¸å¼‚å¸¸çŠ¶æ€

1. **åŠ è½½çŠ¶æ€**: Canvas ä¸Šç”Ÿæˆ "Ghost Node" (å ä½ç¬¦)ï¼Œæ˜¾ç¤ºå‘¼å¸ç¯åŠ¨ç”»ã€‚
    
2. **ç»“æœå›å†™**:
    
    - æ–‡æœ¬ä»»åŠ¡ -> Text Nodeã€‚
        
    - å›¾åƒä»»åŠ¡ -> ä¿å­˜æ–‡ä»¶è‡³ Vault -> File Nodeã€‚
        
3. **å¼‚å¸¸å¤„ç†**:
    
    - **å®‰å…¨æ‹¦æˆª**: Ghost Node å˜ä¸ºç°è‰² ğŸš« å›¾æ ‡ï¼Œç‚¹å‡»æ˜¾ç¤º "Blocked by safety filters"ã€‚
        
    - **API é”™è¯¯**: Ghost Node å˜ä¸ºçº¢è‰² âš ï¸ å›¾æ ‡ï¼Œæä¾› `[Retry]` æŒ‰é’®ã€‚
        

## 3. æŠ€æœ¯å®ç°æ–¹æ¡ˆ (Technical Architecture)

è¿™æ˜¯æœ¬æ’ä»¶çš„æ ¸å¿ƒé€»è¾‘ç®¡çº¿ (Pipeline)ã€‚

### 3.1 åŸºç¡€æ¶æ„

- **æœ¬åœ°é¢„å¤„ç†**: ä¸ç›´æ¥å‘é€ JSONCanvasï¼Œè€Œåœ¨æœ¬åœ°è½¬æ¢ä¸º Markdown/Mermaid/Base64ã€‚
    
- **å¼‚æ­¥é˜Ÿåˆ—**: ä½¿ç”¨ `TaskQueue` ç®¡ç†å¹¶å‘è¯·æ±‚ï¼Œä¸é˜»å¡ UI çº¿ç¨‹ã€‚
    

### 3.2 æ ¸å¿ƒé€»è¾‘ï¼šæ™ºèƒ½æ„å›¾è§£æç®¡çº¿ (Intelligent Intent Pipeline)

å½“ç”¨æˆ·ç‚¹å‡» "Generate" æ—¶ï¼Œæ•°æ®æµç»ä»¥ä¸‹ä¸‰ä¸ªæ­¥éª¤ï¼š

#### Step 0: é€‰åŒºæ ‡å‡†åŒ– (Pre-processing & Unwrapping)

- **è¾“å…¥**: ç”¨æˆ·é€‰ä¸­çš„ `selectedNodes`ã€‚
    
- **é€»è¾‘**:
    
    1. **Group è§£åŒ…**: å¦‚æœé€‰ä¸­äº† Groupï¼Œè®¡ç®—å…¶å‡ ä½•èŒƒå›´ï¼Œè‡ªåŠ¨å°†èŒƒå›´å†…**æœªè¢«é€‰ä¸­**çš„å­èŠ‚ç‚¹åŠ å…¥å¤„ç†åˆ—è¡¨ã€‚
        
    2. **æ–‡ä»¶æ¸…æ´—**: å‰”é™¤éå›¾ç‰‡æ–‡ä»¶ï¼ˆå¦‚ PDFï¼‰ï¼Œå‰”é™¤è¶…å¤§å›¾ç‰‡ï¼ˆæˆ–è§¦å‘è‡ªåŠ¨å‹ç¼©ï¼‰ã€‚
        
- **è¾“å‡º**: æ‰å¹³åŒ–çš„ `effectiveSelection` åˆ—è¡¨ã€‚
    

#### Step 1: è§’è‰²è§£æ (Graph-based Role Assignment)

- **ç›®æ ‡**: ç¡®å®šæ¯å¼ å›¾ç‰‡åœ¨ Prompt ä¸­çš„ä½œç”¨ï¼ˆRoleï¼‰ã€‚
    
- **è§£æä¼˜å…ˆçº§**:
    
    1. **æ˜¾å¼è¿çº¿ (Labeled Edge)**: è¿çº¿æŒ‡å‘å›¾ç‰‡ä¸”å¸¦æœ‰ Label -> `Role = Edge.Label` (e.g., "Style").
        
    2. **ä¸Šæ¸¸æ–‡æœ¬ (Upstream Text)**: æ–‡æœ¬èŠ‚ç‚¹è¿çº¿æŒ‡å‘å›¾ç‰‡ -> `Role = TextNode.Text`.
        
    3. **åˆ†ç»„æ ‡é¢˜ (Group Context)**: å›¾ç‰‡åœ¨ Group å†… -> `Role = Group.Label`.
        
    4. **é»˜è®¤**: `Role = "Visual Reference"`.
        

#### Step 2: æŒ‡ä»¤ç­–ç•¥ (Instruction Strategy)

- **ç›®æ ‡**: ç¡®å®šæœ€ç»ˆå‘ç»™ AI çš„æ–‡å­—æŒ‡ä»¤ã€‚
    
- **åˆ¤å®šé€»è¾‘**:
    
    1. **ç”¨æˆ·è¾“å…¥ä¼˜å…ˆ**: å¦‚æœæ‚¬æµ®é¢æ¿è¾“å…¥æ¡†æœ‰å†…å®¹ -> ä½¿ç”¨è¾“å…¥å†…å®¹ã€‚
        
    2. **è‡ªåŠ¨å›é€€**: å¦‚æœè¾“å…¥æ¡†ä¸ºç©º -> æå– `effectiveSelection` ä¸­**æœªè¢«ç”¨ä½œæ ‡ç­¾**çš„çº¯æ–‡æœ¬èŠ‚ç‚¹å†…å®¹ã€‚
        
    3. **é»˜è®¤é¢„è®¾**: å¦‚æœéƒ½ä¸ºç©º -> ä½¿ç”¨é»˜è®¤æç¤ºè¯ ("Summarize this" / "Generate image from refs").
        

### 3.3 å¸ƒå±€ä¸é˜²å‘†è®¾è®¡ (Safety & Layout)

#### A. æ™ºèƒ½å¸ƒå±€ (Smart Layout)

- è®¡ç®—é€‰åŒºåŒ…å›´ç›’ `maxX`ã€‚
    
- æ–°èŠ‚ç‚¹ç”Ÿæˆäº `x = maxX + 50`, `y = minY`ã€‚
    
- ç®€å•çš„ç¢°æ’æ£€æµ‹ï¼Œè‹¥ä½ç½®è¢«å åˆ™å‘ä¸‹åç§»ã€‚
    

#### B. é˜²å‘†ä¸è¾¹ç•Œä¿æŠ¤ (Safety Rails)

1. **å›¾ç‰‡æ•°é‡é™åˆ¶**: Gemini 3 é™åˆ¶ **14 å¼ **ã€‚è¶…è¿‡æ—¶è‡ªåŠ¨æˆªæ–­å¹¶åœ¨ UI è­¦å‘Šã€‚
    
2. **å¾ªç¯è¿çº¿æ£€æµ‹**: éå†å›¾è°±æ—¶ç»´æŠ¤ `visited` é›†åˆï¼Œé˜²æ­¢æ­»å¾ªç¯ã€‚
    
3. **è‡ªåŠ¨å‹ç¼©**: åœ¨è½¬ Base64 å‰ï¼Œè‹¥å›¾ç‰‡ > 4096pxï¼Œä½¿ç”¨ OffscreenCanvas ç¼©å°ï¼Œé˜²æ­¢ API è¶…æ—¶ã€‚
    
4. **ç©ºæŒ‡ä»¤ä¿æŠ¤**: è‹¥æ— å›¾æ— å­—æ— è¾“å…¥ï¼Œç¦ç”¨ Generate æŒ‰é’®ã€‚

### 3.4 éš¾ç‚¹å››ï¼šåŸºäºå›¾è°±çš„æ„å›¾è§£æ (Graph-based Intent Resolver)

è¿™æ˜¯æœ¬æ’ä»¶çš„æ ¸å¿ƒå·®å¼‚åŒ–åŠŸèƒ½ã€‚æˆ‘ä»¬éœ€è¦å°† Canvas çš„**æ‹“æ‰‘ç»“æ„**ç¿»è¯‘ä¸º Gemini èƒ½ç†è§£çš„ **è¯­ä¹‰ç»“æ„**ã€‚

#### Step 0: é€‰åŒºé¢„å¤„ç†ä¸ Group å±•å¼€ (Pre-processing) **[ä¼˜åŒ–ç‚¹ 2]**

åœ¨å¼€å§‹è§£æå‰ï¼Œå¿…é¡»å…ˆæ ‡å‡†åŒ–è¾“å…¥æºã€‚

1. **Group Unwrapping (è‡ªåŠ¨è§£åŒ…)**
    
    - éå†ç”¨æˆ·é€‰ä¸­çš„ `selectedNodes`ã€‚
        
    - å¦‚æœé‡åˆ°ç±»å‹ä¸º `group` çš„èŠ‚ç‚¹ï¼š
        
        - è®¡ç®—è¯¥ Group çš„å‡ ä½•èŒƒå›´ (x, y, w, h)ã€‚
            
        - æ‰«æ Canvas ä¸Š**æ‰€æœ‰æœªè¢«é€‰ä¸­**çš„èŠ‚ç‚¹ã€‚
            
        - **åŒ…å«æ£€æµ‹**: å¦‚æœæŸä¸ªèŠ‚ç‚¹çš„ä¸­å¿ƒç‚¹ä½äºè¯¥ Group èŒƒå›´å†…ï¼Œå°†å…¶åŠ å…¥ `effectiveSelection` (æœ‰æ•ˆé€‰åŒº) åˆ—è¡¨ã€‚
            
        - ä¿ç•™ Group èŠ‚ç‚¹æœ¬èº«ï¼ˆå…¶ Label å¯èƒ½ä½œä¸ºè¯­ä¹‰ Tagï¼‰ï¼Œä½†æ ‡è®°ä¸º "Container"ã€‚
            
    - æœ€ç»ˆè¾“å‡ºä¸€ä¸ªæ‰å¹³åŒ–çš„ `effectiveSelection` åˆ—è¡¨ï¼ŒåŒ…å«æ‰€æœ‰å®é™…éœ€è¦å¤„ç†çš„å›¾æ–‡èŠ‚ç‚¹ã€‚
        

#### Step 1: è§’è‰²è§£æ (Role Assignment)

_(ä¿æŒåŸé€»è¾‘ï¼šåˆ©ç”¨è¿çº¿ Label > ä¸Šæ¸¸æ–‡æœ¬ > Group æ ‡é¢˜ æ¥ç¡®å®šå›¾ç‰‡ç”¨é€”)_

#### Step 2: Prompt æå–ç­–ç•¥ (Instruction Fallback Strategy) **[ä¼˜åŒ–ç‚¹ 1]**

åœ¨æ„é€ æœ€ç»ˆ Payload æ—¶ï¼Œ`INSTRUCTION` å­—æ®µçš„å†…å®¹æ¥æºéµå¾ªä»¥ä¸‹**ä¼˜å…ˆçº§å›é€€æœºåˆ¶**ï¼š

1. **Priority A (Explicit Input)**: ç”¨æˆ·åœ¨æ‚¬æµ®é¢æ¿ **è¾“å…¥æ¡†** ä¸­å¡«å†™çš„å†…å®¹ã€‚
    
2. **Priority B (In-Context Text)**:
    
    - å¦‚æœè¾“å…¥æ¡†ä¸ºç©ºã€‚
        
    - æ£€æŸ¥ `effectiveSelection` ä¸­æ˜¯å¦æœ‰ **æœªè¢«ç”¨ä½œæ ‡ç­¾** çš„æ–‡æœ¬èŠ‚ç‚¹ã€‚
        
    - å¦‚æœæœ‰ï¼Œåˆå¹¶è¿™äº›æ–‡æœ¬èŠ‚ç‚¹çš„å†…å®¹ä½œä¸ºæŒ‡ä»¤ã€‚
        
3. **Priority C (Default Preset)**:
    
    - å¦‚æœä»¥ä¸Šçš†ç©ºã€‚
        
    - **Chat æ¨¡å¼**: "Summarize the selected content."
        
    - **Image æ¨¡å¼**: "Generate an image based on these references."
        

#### ç¤ºä¾‹åœºæ™¯å¤„ç† (ä¼˜åŒ–å)

- **åœºæ™¯**: ç”¨æˆ·åœ¨ä¸€ä¸ª Group é‡Œæ”¾äº† 3 å¼ å‚è€ƒå›¾ï¼Œå¹¶æ²¡æœ‰å†™ä»»ä½• Promptï¼Œç›´æ¥é€‰ä¸­ Group ç‚¹å‡» "Generate Image"ã€‚
    
- **å¤„ç†æµç¨‹**:
    
    1. **å±•å¼€**: æ’ä»¶å‘ç°é€‰ä¸­äº† Groupï¼Œè‡ªåŠ¨è¯†åˆ«å‡ºå†…éƒ¨çš„ 3 å¼ å›¾ç‰‡ã€‚
        
    2. **è§£æ**: 3 å¼ å›¾ç‰‡è¢«ä½œä¸º `image_url` åŠ å…¥ Payloadã€‚
        
    3. **Prompt**: è¾“å…¥æ¡†ä¸ºç©º -> æ£€æŸ¥é€‰åŒºæ— æ–‡æœ¬ -> ä½¿ç”¨é»˜è®¤ Prompt "Generate an image based on these references."ã€‚
        
    4. **ç»“æœ**: Gemini 3 å¼€å§‹åŸºäºè¿™ 3 å¼ å›¾è¿›è¡Œæ··åˆ/å˜ä½“ç”Ÿæˆã€‚


### 3.5 éš¾ç‚¹äº”ï¼šæ™ºèƒ½å¸ƒå±€ä¸èŠ‚ç‚¹å®šä½ (Layout Algorithm)

ä¸ºäº†é˜²æ­¢æ–°ç”Ÿæˆçš„èŠ‚ç‚¹é®æŒ¡ç°æœ‰å†…å®¹ï¼Œéœ€è¦å®ç°ç®€å•çš„é¿è®©ç®—æ³•ã€‚

1. **è®¡ç®—åŒ…å›´ç›’ (Bounding Box)**:
    
    - éå†æ‰€æœ‰é€‰ä¸­èŠ‚ç‚¹ï¼Œè®¡ç®—æ•´ä½“çš„ `minX`, `minY`, `maxX`, `maxY`ã€‚
        
2. **å®šä½ç­–ç•¥**:
    
    - **é»˜è®¤ä½ç½®**: `x = maxX + 50` (å³ä¾§ 50px), `y = minY` (é¡¶éƒ¨å¯¹é½)ã€‚
        
    - **å°ºå¯¸é¢„è®¾**:
        
        - Text Node: å®½åº¦å›ºå®š 400pxï¼Œé«˜åº¦è‡ªé€‚åº”ã€‚
            
        - Image Node: é»˜è®¤ 500x500px (åç»­æ ¹æ®å›¾ç‰‡æ¯”ä¾‹è°ƒæ•´)ã€‚
            
3. **ç¢°æ’æ£€æµ‹ (å¯é€‰ä¼˜åŒ–)**:
    
    - æ£€æŸ¥é»˜è®¤ä½ç½®æ˜¯å¦å·²æœ‰å…¶ä»–èŠ‚ç‚¹ã€‚å¦‚æœæœ‰ï¼Œåˆ™å‘ä¸‹åç§» `y += 50` ç›´åˆ°æ‰¾åˆ°ç©ºä½ï¼Œæˆ–å‘æ›´å³ä¾§åç§»ã€‚


### 3.6 éš¾ç‚¹å…­ï¼šé˜²å‘†è®¾è®¡ä¸è¾¹ç•Œä¿æŠ¤ (Safety Rails & Validation)

ä¸ºäº†é˜²æ­¢ç”¨æˆ·è¯¯æ“ä½œå¯¼è‡´ API æŠ¥é”™ã€Token çˆ†ç‚¸æˆ–ç¨‹åºå´©æºƒï¼Œå¿…é¡»åœ¨ **Request å‘é€å‰** å¢åŠ ä¸€å±‚æ‹¦æˆªæ ¡éªŒã€‚

#### A. è¾“å…¥æ ¡éªŒ (Pre-flight Validation)

1. **å›¾ç‰‡æ•°é‡é™åˆ¶ (Max Image Count)**
    
    - **è§„åˆ™**ï¼šGemini 3 Pro Image ç›®å‰é™åˆ¶æœ€å¤š **14 å¼ ** å‚è€ƒå›¾ã€‚
        
    - **åŠ¨ä½œ**ï¼šå¦‚æœç”¨æˆ·é€‰ä¸­ > 14 å¼ å›¾ç‰‡ï¼Œæ‚¬æµ®é¢æ¿æ˜¾ç¤ºé»„è‰²è­¦å‘Šï¼š"Selected images (15) exceed the limit (14). First 14 will be used."ï¼Œå¹¶è‡ªåŠ¨æˆªæ–­ã€‚
        
2. **æ–‡ä»¶å¤§å°ä¸ç±»å‹æ¸…æ´— (Sanitization)**
    
    - **è§„åˆ™**ï¼šAPI é™åˆ¶å•å¼ å›¾ç‰‡å¤§å°ï¼ˆé€šå¸¸ < 7MB æˆ– < 20MBï¼Œè§† Base64 é™åˆ¶è€Œå®šï¼‰ã€‚
        
    - **åŠ¨ä½œ**ï¼š
        
        - **éå›¾ç‰‡è¿‡æ»¤**ï¼šå¦‚æœç”¨æˆ·æ¡†é€‰äº† PDF æˆ– MP3ï¼Œè‡ªåŠ¨å‰”é™¤å¹¶åœ¨ UI æç¤º "Skipped non-image files"ã€‚
            
        - **è‡ªåŠ¨å‹ç¼©**ï¼šåœ¨è½¬ Base64 å‰ï¼Œæ£€æµ‹å›¾ç‰‡åˆ†è¾¨ç‡ã€‚å¦‚æœå®½/é«˜ > 4096px æˆ–ä½“ç§¯è¿‡å¤§ï¼Œåœ¨æœ¬åœ° Canvas ä½¿ç”¨ OffscreenCanvas è¿›è¡Œ **Downscaling (ç¼©å°)** å¤„ç†ï¼Œç¡®ä¿è¯·æ±‚æˆåŠŸç‡ã€‚
            
3. **å¾ªç¯è¿çº¿æ£€æµ‹ (Loop Detection)**
    
    - **åœºæ™¯**ï¼šç”¨æˆ·å°†æ–‡æœ¬ A è¿å‘ æ–‡æœ¬ Bï¼ŒB åˆè¿å› Aã€‚
        
    - **åŠ¨ä½œ**ï¼šåœ¨ DFS/BFS éå†æ„å»º Context æ—¶ï¼Œç»´æŠ¤ä¸€ä¸ª `visited` é›†åˆã€‚å¦‚æœæ£€æµ‹åˆ°é—­ç¯ï¼Œè‡ªåŠ¨ä¸­æ–­éå†ï¼Œé¿å…æ­»å¾ªç¯å¯¼è‡´æ’ä»¶å¡æ­»ã€‚
        

#### B. å¼‚å¸¸çŠ¶æ€äº¤äº’ (Error States)

1. **ç©ºæŒ‡ä»¤ä¿æŠ¤**
    
    - **åœºæ™¯**ï¼šç”¨æˆ·åªé€‰äº†å›¾ç‰‡ï¼Œæ²¡å†™ Promptï¼Œä¹Ÿæ²¡é€‰æŒ‡ä»¤æ–‡æœ¬ã€‚
        
    - **åŠ¨ä½œ**ï¼šPrompt Input æ¡†æ˜¾ç¤ºçº¢è‰²æç¤ºï¼Œæˆ–è‡ªåŠ¨å¡«å……é»˜è®¤ Promptï¼š"Describe these images." (Chatæ¨¡å¼) æˆ– "Generate a variation." (Imageæ¨¡å¼)ã€‚
        
2. **API å¯†é’¥ç¼ºå¤±**
    
    - **åœºæ™¯**ï¼šç”¨æˆ·åˆšå®‰è£…æ’ä»¶ï¼Œæœªé…ç½® Key å°±ç‚¹å‡»ç”Ÿæˆã€‚
        
    - **åŠ¨ä½œ**ï¼šä¸å‘é€è¯·æ±‚ï¼Œç›´æ¥åœ¨æ‚¬æµ®é¢æ¿å¼¹å‡ºæŒ‰é’® `[Go to Settings]`ï¼Œå¼•å¯¼ç”¨æˆ·é…ç½®ã€‚
        
3. **å®‰å…¨è¿‡æ»¤å™¨æ‹¦æˆª (Safety Filter Triggered)**
    
    - **åœºæ™¯**ï¼šGemini å› ä¸º NSFW æˆ–å®‰å…¨åŸå› æ‹’ç»ç”Ÿæˆã€‚
        
    - **åŠ¨ä½œ**ï¼š
        
        - ä¸è¦ç›´æ¥é™é»˜å¤±è´¥ã€‚
            
        - ç”Ÿæˆçš„ Ghost Node å˜ä¸º **ç°è‰²ç¦æ­¢å›¾æ ‡ ğŸš«**ã€‚
            
        - ç‚¹å‡»æ˜¾ç¤ºï¼š"Request blocked by safety filters. Please modify your prompt."
    

## 4. API Payload è®¾è®¡

æ ¹æ®ä¸Šè¿°ç®¡çº¿è§£æåçš„åŠ¨æ€ JSON ç»“æ„ã€‚

```
{
  "model": "google/gemini-3-pro-image-preview",
  "messages": [
    {
      "role": "user",
      "content": [
        // System Context
        {
          "type": "text",
          "text": "You are an expert creator. Use the following references."
        },
        
        // --- åŠ¨æ€æ’å…¥éƒ¨åˆ† (æ¥è‡ª Step 1 è§£æ) ---
        // [Group å±•å¼€å] è‡ªåŠ¨æå–çš„å›¾ç‰‡ A
        { "type": "text", "text": "\n[Ref: Group Content]" },
        { "type": "image_url", "image_url": { "url": "..." } },
        
        // [Group å±•å¼€å] è‡ªåŠ¨æå–çš„å›¾ç‰‡ B
        { "type": "text", "text": "\n[Ref: Group Content]" },
        { "type": "image_url", "image_url": { "url": "..." } },
        
        // --- æŒ‡ä»¤éƒ¨åˆ† (æ¥è‡ª Step 2 ç­–ç•¥) ---
        // å¦‚æœç”¨æˆ·æ²¡è¾“å…¥ï¼Œè¿™é‡Œå¯èƒ½ç›´æ¥å¡«å……äº†é€‰ä¸­å¡ç‰‡é‡Œçš„æ–‡å­—
        {
          "type": "text",
          "text": "\nINSTRUCTION: A cyberpunk city street..." 
        }
      ]
    }
  ]
}
```
## 5. æ’ä»¶è®¾ç½® (Settings)

### 5.1 API Provider ç®¡ç†

- æ”¯æŒå¤šå‚å•† (Gemini, OpenRouter, Custom)ã€‚
    
- å­—æ®µ: Name, Base URL, API Key, Model Name.
    

### 5.2 é¢„è®¾ç®¡ç† (Prompt Presets)

- å¢åˆ æ”¹æŸ¥å¸¸ç”¨ Promptã€‚
    

### 5.3 é€šç”¨ä¸è·¯å¾„

- **Image Output Path**: [ Root | Current | **Attachment** | Custom ] (é»˜è®¤å­˜å…¥é™„ä»¶æ–‡ä»¶å¤¹)ã€‚
    
- **System Prompt**: è‡ªå®šä¹‰å…¨å±€ç³»ç»Ÿæç¤ºè¯ã€‚
    

### 5.4 é«˜çº§ä¸å®‰å…¨

- **Max Reference Images**: [ Slider: 1-14 ]ã€‚
    
- **Auto-Resize Large Images**: [ Toggle: On ]ã€‚
    

---

## 6. å¼€å‘æ‰§è¡Œè·¯çº¿å›¾ (Execution Plan)

1. **Phase 1: éª¨æ¶ä¸ UI (Skeleton)**
    
    - æ­å»ºè®¾ç½®é¡µã€æ‚¬æµ®é¢æ¿ UIã€‚
        
    - å®ç°è¿™ä¸€æ­¥å³å¯è¿›è¡Œ UI äº¤äº’æµ‹è¯•ã€‚
        
2. **Phase 2: æ ¸å¿ƒè§£æå™¨ (The Resolver)**
    
    - å®ç° `CanvasInputResolver.ts`ã€‚
        
    - é‡ç‚¹ï¼š**Group è§£åŒ…ç®—æ³•**ã€**è¿çº¿éå†é€»è¾‘**ã€‚
        
    - æµ‹è¯•ï¼šConsole log è¾“å‡ºè§£æåçš„ç»“æ„åŒ–æ•°æ®ã€‚
        
3. **Phase 3: è§†è§‰é›†æˆ (Vision)**
    
    - å®ç°å›¾ç‰‡è¯»å– (`vault.readBinary`)ã€å‹ç¼©ã€Base64 è½¬æ¢ã€‚
        
    - å¯¹æ¥ Gemini 3 APIã€‚
        
4. **Phase 4: å®Œå–„ä¸å‘å¸ƒ (Polish)**
    
    - æ¥å…¥é˜²å‘†æ ¡éªŒã€‚
        
    - ä¼˜åŒ–é”™è¯¯æç¤ºä¸ Ghost Node åŠ¨ç”»ã€‚
        
    - å¤„ç†æ–‡ä»¶ä¿å­˜è·¯å¾„é€»è¾‘ã€‚