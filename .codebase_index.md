# Codebase Index

> 项目：`ObsidianCanvasAI`（插件名：Canvas Banana）  
> 更新时间：2026-02-26  
> 用途：快速了解仓库结构，减少无效全量阅读；后续检索建议优先按本索引定位文件再精读。

## 1. 项目概览

- 类型：Obsidian 插件（TypeScript）
- 入口：`main.ts`（打包后输出 `main.js`）
- 核心能力：Canvas 对话/改写/节点生成、笔记侧栏 Copilot、文内生图、多 Provider API 接入
- 主要技术栈：TypeScript + esbuild + ESLint（obsidianmd 规则）

## 2. 顶层目录速览

- `src/`：核心业务代码（39 个 `.ts` 文件）
- `lang/`：i18n 文案与翻译工具
- `docs/`：设计文档、实现记录、方案草案
- `.github/workflows/`：发布流程（tag 触发 release）
- `main.ts`：插件入口与生命周期、事件注册、模块装配
- `styles.css`：插件样式
- `manifest.json` / `versions.json`：Obsidian 插件元信息与版本映射

## 3. 源码模块地图（`src/`）

### 3.1 API 层（`src/api/`，7 文件）

- `api-manager.ts`：统一 API 调用入口与 Provider 调度
- `providers/`：
  - `gemini.ts`
  - `openrouter.ts`
  - `gptgod.ts`
- `types.ts`：API 交互类型定义
- `utils.ts` / `thinking-utils.ts`：请求辅助逻辑、思考过程处理

### 3.2 Canvas 逻辑（`src/canvas/`，7 文件）

- `intent-resolver.ts`：指令意图解析（文本/编辑/节点等模式）
- `canvas-converter.ts`：Canvas 节点与结构转换
- `node-mode-utils.ts`：节点模式的提取/重排/优化工具
- `node-operations.ts`：节点创建/分组/选择等操作
- `image-viewer.ts`：图片查看与复制
- `utilities.ts` / `ghost-node.ts`：画布通用工具与占位节点相关能力

### 3.3 Notes 逻辑（`src/notes/`，9 文件）

- `sidebar-copilot-view.ts`：笔记侧栏 Copilot 视图（体量最大）
- `notes-selection-handler.ts`：笔记选区处理与交互分发
- `notes-edit-palette.ts`：笔记编辑悬浮操作面板
- `note-image-task-manager.ts`：笔记生图任务管理
- `text-patcher.ts`：文本补丁应用
- `mode-controller.ts` / `notes-floating-button.ts` / `shared-ui-builder.ts` / `index.ts`：模式控制、按钮、共享 UI 与导出

### 3.4 UI 与设置

- `src/ui/floating-palette.ts`：主悬浮面板 UI 与交互流程
- `src/ui/modals.ts`：弹窗（如 diff 审阅）
- `src/ui/preset-manager.ts`：提示词预设管理
- `src/settings/settings.ts`：设置结构与默认值
- `src/settings/settings-tab.ts`：设置页 UI（体量较大）

### 3.5 其他核心模块

- `src/core/ghost-node-manager.ts`：Ghost Node 管理
- `src/prompts/`：系统提示词模板（聊天/编辑/节点）
- `src/utils/`：调试、格式化、图片辅助
- `src/types.ts`：Canvas/插件共享类型定义

## 4. 非源码目录

- `lang/helpers.ts`：翻译函数入口
- `lang/locale/en.json` / `lang/locale/zh-cn.json`：中英文文案
- `docs/design_doc_v2.md`：设计文档（较新）
- `docs/implementedfeatures.md`：已实现功能清单
- `docs/plans/`：各专题设计草案（notes、chat、图像生成等）

## 5. 构建、检查、发布

- 开发：`npm run dev`
- 构建：`npm run build`
- Lint：`npm run lint`
- 版本同步：`npm run version-sync`
- 发布流：`.github/workflows/release.yml`
  - 触发条件：push tag
  - 产物：`main.js`、`manifest.json`、`styles.css`、zip 包

## 6. 快速阅读路径（建议）

1. `main.ts`：掌握入口、生命周期与模块装配
2. `src/ui/floating-palette.ts`：理解核心交互流
3. `src/api/api-manager.ts` + `src/api/providers/*`：理解模型调用链路
4. `src/canvas/intent-resolver.ts` + `src/canvas/canvas-converter.ts`：理解 Canvas 能力
5. `src/notes/sidebar-copilot-view.ts` + `src/notes/notes-selection-handler.ts`：理解 Notes 能力
6. `src/settings/settings.ts` + `src/settings/settings-tab.ts`：理解配置面

## 7. 大文件热点（优先按需读）

- `main.ts`（72768）
- `src/notes/sidebar-copilot-view.ts`（58013）
- `src/settings/settings-tab.ts`（49779）
- `src/notes/notes-selection-handler.ts`（48332）
- `src/ui/floating-palette.ts`（45077）
- `src/canvas/intent-resolver.ts`（32690）
- `src/canvas/canvas-converter.ts`（23437）

## 8. 检索建议（减少全量扫描）

- 查“入口/事件注册”：`main.ts`
- 查“模型请求失败/超时/流式”：`src/api/`、`src/api/providers/`
- 查“Canvas 节点生成/布局”：`src/canvas/intent-resolver.ts`、`src/canvas/node-mode-utils.ts`
- 查“笔记选区/侧栏交互”：`src/notes/notes-selection-handler.ts`、`src/notes/sidebar-copilot-view.ts`
- 查“设置项定义/渲染”：`src/settings/settings.ts`、`src/settings/settings-tab.ts`
- 查“提示词模板”：`src/prompts/`

## 9. 维护规则（建议）

- 新增目录或关键模块后，同步更新本文件第 2、3、6 节
- 若大文件发生明显变更（>20%），同步更新第 7 节
- 若构建/发布命令变更，同步更新第 5 节
