# ä¸»å…¥å£æ¨¡å—

<cite>
**æœ¬æ–‡å¼•ç”¨çš„æ–‡ä»¶**
- [main.ts](file://main.ts)
- [intent-resolver.ts](file://intent-resolver.ts)
- [canvas-converter.ts](file://canvas-converter.ts)
- [api-manager.ts](file://api-manager.ts)
- [types.ts](file://types.ts)
- [design_doc.md](file://docs/design_doc.md)
</cite>

## ç›®å½•
1. [ç®€ä»‹](#ç®€ä»‹)
2. [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
3. [æ ¸å¿ƒç»„ä»¶](#æ ¸å¿ƒç»„ä»¶)
4. [æ¶æ„æ€»è§ˆ](#æ¶æ„æ€»è§ˆ)
5. [è¯¦ç»†ç»„ä»¶åˆ†æ](#è¯¦ç»†ç»„ä»¶åˆ†æ)
6. [ä¾èµ–åˆ†æ](#ä¾èµ–åˆ†æ)
7. [æ€§èƒ½è€ƒé‡](#æ€§èƒ½è€ƒé‡)
8. [æ•…éšœæ’æŸ¥æŒ‡å—](#æ•…éšœæ’æŸ¥æŒ‡å—)
9. [ç»“è®º](#ç»“è®º)
10. [é™„å½•](#é™„å½•)

## ç®€ä»‹
æœ¬æ–‡ä»¶é¢å‘ ObsidianCanvasAI æ’ä»¶çš„ä¸»å…¥å£æ¨¡å— main.tsï¼Œç³»ç»Ÿæ€§æ¢³ç†å…¶ä½œä¸ºæ’ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†æ ¸å¿ƒçš„èŒè´£ä¸å®ç°ï¼Œé‡ç‚¹è¦†ç›–ï¼š
- æ’ä»¶ç”Ÿå‘½å‘¨æœŸï¼šonloadã€onUnload çš„åˆå§‹åŒ–ä¸æ¸…ç†æµç¨‹
- Canvas é€‰ä¸­çŠ¶æ€æ£€æµ‹ï¼šé€šè¿‡ç›‘å¬ 'layout-change' ä¸è½®è¯¢æœºåˆ¶ï¼Œç»“åˆåŸç”Ÿèœå•æ³¨å…¥ï¼ŒåŠ¨æ€æ˜¾ç¤ºæ‚¬æµ®é¢æ¿ï¼ˆFloating Paletteï¼‰
- æ‚¬æµ®é¢æ¿ UI æ„å»ºï¼šTab æ¨¡å¼åˆ‡æ¢ï¼ˆèŠå¤©/ç”Ÿå›¾ï¼‰ã€è¾“å…¥åŒºã€å‚æ•°æ§åˆ¶åŒºã€é¢„è®¾ç®¡ç†ä¸ç”ŸæˆæŒ‰é’®äº¤äº’
- ä¸Šä¸‹æ–‡è½¬æ¢ä¸ API åè°ƒï¼šé€šè¿‡ IntentResolver ä¸ CanvasConverter è¿›è¡Œä¸Šä¸‹æ–‡è§£æä¸è½¬æ¢ï¼Œå†ç”± ApiManager å‘èµ·è¯·æ±‚
- â€˜Ghost Nodeâ€™ æ¦‚å¿µä¸ä»»åŠ¡æ‰§è¡Œï¼šåœ¨ Canvas ä¸Šåˆ›å»ºåŠ è½½å ä½ç¬¦ï¼Œå¼‚æ­¥å›å†™ç»“æœæˆ–é”™è¯¯çŠ¶æ€
- äº‹ä»¶ç›‘å¬ã€DOM æ“ä½œä¸çŠ¶æ€ç®¡ç†çš„æœ€ä½³å®è·µï¼Œä»¥åŠæ½œåœ¨å†…å­˜æ³„æ¼é£é™©ä¸æ²»ç†å»ºè®®

## é¡¹ç›®ç»“æ„
main.ts ä½äºæ’ä»¶æ ¹ç›®å½•ï¼Œæ˜¯æ’ä»¶çš„å”¯ä¸€å…¥å£ï¼Œè´Ÿè´£ï¼š
- æ’ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆonload/onUnloadï¼‰
- Canvas é€‰ä¸­çŠ¶æ€ç›‘å¬ä¸æ‚¬æµ®é¢æ¿æ³¨å…¥
- æ‚¬æµ®é¢æ¿ç»„ä»¶çš„åˆå§‹åŒ–ä¸äº¤äº’å›è°ƒç»‘å®š
- ä»»åŠ¡è°ƒåº¦ä¸ç»“æœå›å†™ï¼ˆå« Ghost Nodeï¼‰

```mermaid
graph TB
A["main.ts<br/>æ’ä»¶å…¥å£"] --> B["FloatingPalette<br/>æ‚¬æµ®é¢æ¿"]
A --> C["ApiManager<br/>API ç®¡ç†å™¨"]
A --> D["IntentResolver<br/>æ„å›¾è§£æ"]
D --> E["CanvasConverter<br/>ä¸Šä¸‹æ–‡è½¬æ¢"]
E --> F["types.ts<br/>Canvas ç±»å‹å®šä¹‰"]
A --> G["design_doc.md<br/>è®¾è®¡æ–‡æ¡£"]
```

å›¾è¡¨æ¥æº
- [main.ts](file://main.ts#L914-L1030)
- [intent-resolver.ts](file://intent-resolver.ts#L63-L130)
- [canvas-converter.ts](file://canvas-converter.ts#L1-L120)
- [api-manager.ts](file://api-manager.ts#L71-L142)
- [types.ts](file://types.ts#L21-L119)
- [design_doc.md](file://docs/design_doc.md#L1-L70)

ç« èŠ‚æ¥æº
- [main.ts](file://main.ts#L914-L1030)

## æ ¸å¿ƒç»„ä»¶
- æ’ä»¶ä¸»ç±» CanvasAIPluginï¼šè´Ÿè´£æ’ä»¶ç”Ÿå‘½å‘¨æœŸã€æ‚¬æµ®é¢æ¿åˆå§‹åŒ–ã€Canvas é€‰ä¸­çŠ¶æ€ç›‘å¬ã€ä»»åŠ¡è°ƒåº¦ä¸å›å†™ã€è®¾ç½®æŒä¹…åŒ–ç­‰
- FloatingPaletteï¼šæ‚¬æµ®é¢æ¿ UI ç»„ä»¶ï¼Œè´Ÿè´£ Tab æ¨¡å¼åˆ‡æ¢ã€è¾“å…¥åŒºã€å‚æ•°æ§åˆ¶åŒºã€é¢„è®¾ç®¡ç†ã€ç”ŸæˆæŒ‰é’®äº¤äº’ä¸ä»»åŠ¡è®¡æ•°
- ApiManagerï¼šç»Ÿä¸€ç®¡ç† OpenRouter/Yunwu çš„èŠå¤©ä¸å›¾åƒç”Ÿæˆè¯·æ±‚ï¼Œå°è£…å¤šæ¨¡æ€æ¶ˆæ¯ä½“ä¸å“åº”è§£æ
- IntentResolverï¼šå°† Canvas é€‰åŒºè½¬æ¢ä¸ºç»“æ„åŒ–çš„æ„å›¾ï¼ˆå›¾ç‰‡è§’è‰²ã€æŒ‡ä»¤ã€ä¸Šä¸‹æ–‡æ–‡æœ¬ï¼‰ï¼Œå¹¶è¿›è¡Œå›é€€ç­–ç•¥ä¸è­¦å‘Šæ”¶é›†
- CanvasConverterï¼šå°† Canvas èŠ‚ç‚¹è½¬æ¢ä¸º Markdown/Mermaid æ–‡æœ¬ï¼Œè¯»å–å›¾ç‰‡ä¸ºå‹ç¼©åçš„ WebP Base64ï¼Œæ”¯æŒ group å±•å¼€ä¸è¾¹æå–
- types.tsï¼šCanvas èŠ‚ç‚¹ã€è¾¹ã€è§†å›¾ç­‰ç±»å‹å®šä¹‰ï¼Œä¸ºæ’ä»¶æä¾›ç±»å‹å®‰å…¨çš„ Canvas API æ‰©å±•

ç« èŠ‚æ¥æº
- [main.ts](file://main.ts#L914-L1030)
- [api-manager.ts](file://api-manager.ts#L71-L142)
- [intent-resolver.ts](file://intent-resolver.ts#L63-L130)
- [canvas-converter.ts](file://canvas-converter.ts#L1-L120)
- [types.ts](file://types.ts#L21-L119)

## æ¶æ„æ€»è§ˆ
ä¸‹å›¾å±•ç¤ºäº†æ’ä»¶ä» Canvas é€‰ä¸­çŠ¶æ€æ£€æµ‹åˆ°ä»»åŠ¡æ‰§è¡Œä¸å›å†™çš„ç«¯åˆ°ç«¯æµç¨‹ï¼Œä»¥åŠå„ç»„ä»¶ä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚

```mermaid
sequenceDiagram
participant U as "ç”¨æˆ·"
participant P as "CanvasAIPlugin(main.ts)"
participant FP as "FloatingPalette(main.ts)"
participant IR as "IntentResolver(intent-resolver.ts)"
participant CC as "CanvasConverter(canvas-converter.ts)"
participant AM as "ApiManager(api-manager.ts)"
U->>P : é€‰ä¸­ Canvas èŠ‚ç‚¹
P->>P : ç›‘å¬ layout-change/è½®è¯¢æ£€æµ‹
P->>FP : æ³¨å…¥ AI æŒ‰é’®/æ˜¾ç¤ºé¢æ¿
U->>FP : åˆ‡æ¢ Tab/å¡«å†™è¾“å…¥/é€‰æ‹©å‚æ•°
U->>FP : ç‚¹å‡»â€œç”Ÿæˆâ€
FP->>P : å›è°ƒ handleGeneration(prompt, mode)
P->>IR : resolve(app, canvas, selection, prompt, mode, settings)
IR->>CC : convert(app, canvas, selection, quality, size)
CC-->>IR : è½¬æ¢ç»“æœ(nodes, edges, markdown, mermaid)
IR-->>P : ResolvedIntent(images, instruction, contextText, warnings, canGenerate)
alt æ¨¡å¼=èŠå¤©
P->>AM : chatCompletion/in multimodalChat
AM-->>P : è¿”å›æ–‡æœ¬
P->>P : æ›´æ–° Ghost Node/å›å†™æ–‡æœ¬èŠ‚ç‚¹
else æ¨¡å¼=ç”Ÿå›¾
P->>AM : generateImageWithRoles
AM-->>P : è¿”å›å›¾ç‰‡ data URL
P->>P : ä¿å­˜åˆ° Vault/æ›¿æ¢ä¸º File Node
end
```

å›¾è¡¨æ¥æº
- [main.ts](file://main.ts#L1031-L1150)
- [intent-resolver.ts](file://intent-resolver.ts#L63-L130)
- [canvas-converter.ts](file://canvas-converter.ts#L465-L516)
- [api-manager.ts](file://api-manager.ts#L143-L276)

## è¯¦ç»†ç»„ä»¶åˆ†æ

### æ’ä»¶ç”Ÿå‘½å‘¨æœŸä¸è®¾ç½®ç®¡ç†
- onloadï¼šåŠ è½½è®¾ç½®ã€è¿ç§»æ—§å­—æ®µã€æ³¨å†Œè®¾ç½®é¡µã€åˆå§‹åŒ–æ‚¬æµ®é¢æ¿ã€æ³¨å†Œ Canvas é€‰ä¸­ç›‘å¬
- onUnloadï¼šé”€æ¯æ‚¬æµ®é¢æ¿ DOMï¼Œé‡Šæ”¾èµ„æº
- è®¾ç½®æŒä¹…åŒ–ï¼šloadSettings/saveSettingsï¼Œå˜æ›´ååŒæ­¥ ApiManager çš„ settings å¼•ç”¨

ç« èŠ‚æ¥æº
- [main.ts](file://main.ts#L961-L1006)
- [main.ts](file://main.ts#L1790-L1799)

### Canvas é€‰ä¸­çŠ¶æ€æ£€æµ‹ä¸æ‚¬æµ®é¢æ¿æ³¨å…¥
- äº‹ä»¶ç›‘å¬ï¼š
  - layout-changeï¼šCanvas å¸ƒå±€å˜åŒ–ï¼ˆå«é€‰ä¸­çŠ¶æ€å˜åŒ–ï¼‰
  - mousedownï¼šè®°å½•ç‚¹å‡»æ„å›¾ï¼ˆèƒŒæ™¯ç‚¹å‡»/èŠ‚ç‚¹/è¿çº¿/é¢æ¿/èœå•ï¼‰
  - keydown(ESC/Delete/Backspace)ï¼šESC ç›´æ¥å…³é—­é¢æ¿ï¼›Delete/Backspace æ ‡è®°åˆ é™¤æ„å›¾
  - active-leaf-change/file-openï¼šç¦»å¼€ Canvas è§†å›¾æ—¶éšè—é¢æ¿
  - è½®è¯¢ï¼šæ¯ 200ms æ£€æŸ¥ä¸€æ¬¡é€‰ä¸­çŠ¶æ€ï¼Œæå‡å“åº”é€Ÿåº¦
- é¢æ¿æ³¨å…¥ï¼šå‘ Canvas åŸç”Ÿèœå•æ³¨å…¥ AI æŒ‰é’®ï¼Œç‚¹å‡»åæ˜¾ç¤ºæ‚¬æµ®é¢æ¿
- ä½ç½®ä¸é¢„è§ˆï¼šæ ¹æ®é€‰ä¸­èŠ‚ç‚¹å±å¹•åŒ…å›´ç›’å®šä½é¢æ¿ï¼›å®æ—¶æ›´æ–°ä¸Šä¸‹æ–‡é¢„è§ˆï¼ˆèŠ‚ç‚¹æ•°é‡ä¸ç±»å‹ï¼‰

```mermaid
flowchart TD
Start(["å¼€å§‹"]) --> CheckView["æ£€æŸ¥æ˜¯å¦å¤„äº Canvas è§†å›¾"]
CheckView --> |å¦| Hide["éšè—æ‰€æœ‰æ‚¬æµ®ç»„ä»¶"]
CheckView --> |æ˜¯| GetCanvas["è·å– Canvas å®ä¾‹"]
GetCanvas --> GetSel["è·å– selection é›†åˆ"]
GetSel --> SelEmpty{"selectionSize == 0 ?"}
SelEmpty --> |æ˜¯| ExplicitClose{"èƒŒæ™¯ç‚¹å‡»/åˆ é™¤é”®?"}
ExplicitClose --> |æ˜¯| DelayClose["å»¶æ—¶å…³é—­(50ms)ç¡®è®¤"]
DelayClose --> Close["éšè—é¢æ¿"]
ExplicitClose --> |å¦| WaitSel["ç­‰å¾…æ–°çš„é€‰ä¸­"]
SelEmpty --> |å¦| Reset["é‡ç½®çŠ¶æ€æ ‡è®°"]
Reset --> Inject["æ³¨å…¥ AI æŒ‰é’®"]
Inject --> Visible{"é¢æ¿å¯è§?"}
Visible --> |æ˜¯| UpdatePos["æ ¹æ®é€‰ä¸­åŒ…å›´ç›’æ›´æ–°é¢æ¿ä½ç½®"]
Visible --> |å¦| Show["æ˜¾ç¤ºé¢æ¿"]
UpdatePos --> Preview["æ›´æ–°ä¸Šä¸‹æ–‡é¢„è§ˆ"]
Show --> Preview
Preview --> End(["ç»“æŸ"])
```

å›¾è¡¨æ¥æº
- [main.ts](file://main.ts#L1353-L1599)

ç« èŠ‚æ¥æº
- [main.ts](file://main.ts#L1353-L1599)

### æ‚¬æµ®é¢æ¿ UI ä¸äº¤äº’é€»è¾‘
- DOM ç»“æ„ï¼šåŒ…å« Tabï¼ˆèŠå¤©/ç”Ÿå›¾ï¼‰ã€é¢„è®¾ä¸‹æ‹‰ä¸åŠ¨ä½œæŒ‰é’®ã€è¾“å…¥åŒºã€å‚æ•°æ§åˆ¶åŒºï¼ˆåˆ†è¾¨ç‡/æ¯”ä¾‹/æ¸©åº¦ï¼‰ã€ä¸Šä¸‹æ–‡é¢„è§ˆã€ç”ŸæˆæŒ‰é’®ã€è°ƒè¯•æŒ‰é’®ä¸ç‰ˆæœ¬ä¿¡æ¯
- Tab åˆ‡æ¢ï¼šåˆ‡æ¢æ¨¡å¼æ—¶æ›´æ–°å ä½ç¬¦ã€æ˜¾ç¤º/éšè—å‚æ•°åŒºã€åˆ·æ–°é¢„è®¾ä¸‹æ‹‰
- é¢„è®¾ç®¡ç†ï¼šæ–°å¢/åˆ é™¤/ä¿å­˜/é‡å‘½åï¼Œæ”¯æŒèŠå¤©/ç”Ÿå›¾ä¸¤å¥—é¢„è®¾é›†
- å‚æ•°æ§åˆ¶ï¼šèŠå¤©æ¸©åº¦èŒƒå›´æ ¡éªŒä¸è‡ªåŠ¨ä¿®æ­£ï¼›ç”Ÿå›¾æ¯”ä¾‹/åˆ†è¾¨ç‡å˜æ›´å›è°ƒæŒä¹…åŒ–
- ç”ŸæˆæŒ‰é’®ï¼šå¤šä»»åŠ¡å¹¶å‘è®¡æ•°ï¼Œç‚¹å‡»åç«‹å³éšè—é¢æ¿å¹¶å‘èµ·ä»»åŠ¡ï¼Œå®Œæˆåé€’å‡è®¡æ•°
- é”®ç›˜ä¸ç„¦ç‚¹ï¼šè¾“å…¥æ¡†èšç„¦æ—¶æ¨å…¥ Scopeï¼Œé˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…å½±å“ Canvas èŠ‚ç‚¹

```mermaid
classDiagram
class FloatingPalette {
-containerEl : HTMLElement
-currentMode : "chat"|"image"
-promptInput : HTMLTextAreaElement
-isVisible : boolean
-currentParent : HTMLElement
-onClose : Function
-onDebug : Function
-onGenerate : Function
-onSettingsChange : Function
-apiManager : ApiManager
-pendingTaskCount : number
-imageAspectRatio : string
-imageResolution : string
-chatTemperature : number
-presetSelect : HTMLSelectElement
-presetAddBtn : HTMLButtonElement
-presetDeleteBtn : HTMLButtonElement
-presetSaveBtn : HTMLButtonElement
-presetRenameBtn : HTMLButtonElement
+setOnGenerate(callback)
+setOnSettingsChange(callback)
+initImageOptions(aspectRatio, resolution)
+initChatOptions(temperature)
+setDebugMode(enabled)
+setVersion(version)
+initPresets(chatPresets, imagePresets)
+setOnPresetChange(callback)
+show(x,y,canvasContainer,onClose?)
+updatePosition(x,y,canvasContainer)
+hide()
+updateContextPreview(nodeCount,imageCount,textCount,groupCount?)
+incrementTaskCount()
+decrementTaskCount()
+getPrompt() : string
+clearPrompt()
+getImageOptions() : {aspectRatio,resolution}
+getChatOptions() : {temperature}
}
```

å›¾è¡¨æ¥æº
- [main.ts](file://main.ts#L200-L911)

ç« èŠ‚æ¥æº
- [main.ts](file://main.ts#L200-L911)

### ä»»åŠ¡è°ƒåº¦ä¸ä¸Šä¸‹æ–‡è½¬æ¢
- IntentResolver.resolveï¼šé¢„å¤„ç†ï¼ˆå±•å¼€ groupã€è¿‡æ»¤éå›¾ç‰‡ã€è¯»å– md ä¸å›¾ç‰‡ï¼‰ã€è§’è‰²åˆ†é…ï¼ˆåŸºäºè¾¹æ ‡ç­¾/ä¸Šæ¸¸æ–‡æœ¬/Group æ ‡é¢˜ï¼‰ã€æŒ‡ä»¤å›é€€ç­–ç•¥ï¼ˆç”¨æˆ·è¾“å…¥ > é€‰åŒºæ–‡æœ¬ > é»˜è®¤é¢„è®¾ï¼‰ã€æ„å»ºä¸Šä¸‹æ–‡æ–‡æœ¬ã€ç»Ÿè®¡å¯ç”¨æ€§
- CanvasConverter.convertï¼šå±•å¼€ groupã€æå–èŠ‚ç‚¹/è¾¹ã€è¯»å– md å†…å®¹ä¸å›¾ç‰‡ä¸ºå‹ç¼© WebPã€ç”Ÿæˆ Markdown/Mermaid
- ApiManagerï¼šç»Ÿä¸€èŠå¤©/å›¾åƒç”Ÿæˆæ¥å£ï¼Œæ”¯æŒ OpenRouter/Yunwuï¼Œå¤šæ¨¡æ€æ¶ˆæ¯ä½“æ„é€ ä¸å“åº”è§£æ

```mermaid
sequenceDiagram
participant P as "CanvasAIPlugin"
participant IR as "IntentResolver"
participant CC as "CanvasConverter"
participant AM as "ApiManager"
P->>IR : resolve(app, canvas, selection, prompt, mode, settings)
IR->>CC : expandGroupNodes/extractNodes/readMdFileContents/readImageFileContents
CC-->>IR : nodes, edges, markdown, mermaid
IR-->>P : ResolvedIntent
alt èŠå¤©æ¨¡å¼
P->>AM : chatCompletion/multimodalChat
AM-->>P : æ–‡æœ¬å“åº”
else ç”Ÿå›¾æ¨¡å¼
P->>AM : generateImageWithRoles
AM-->>P : å›¾ç‰‡ data URL
end
```

å›¾è¡¨æ¥æº
- [intent-resolver.ts](file://intent-resolver.ts#L63-L130)
- [canvas-converter.ts](file://canvas-converter.ts#L465-L516)
- [api-manager.ts](file://api-manager.ts#L143-L276)

ç« èŠ‚æ¥æº
- [intent-resolver.ts](file://intent-resolver.ts#L63-L130)
- [canvas-converter.ts](file://canvas-converter.ts#L465-L516)
- [api-manager.ts](file://api-manager.ts#L143-L276)

### â€˜Ghost Nodeâ€™ ä¸ç»“æœå›å†™
- åˆ›å»º Ghost Nodeï¼šåœ¨é€‰ä¸­èŠ‚ç‚¹å³ä¾§åˆ›å»ºæ–‡æœ¬èŠ‚ç‚¹ï¼Œæ˜¾ç¤ºâ€œâœ¨ AI Generating...â€ï¼Œå¹¶æ·»åŠ æ ·å¼ç±»
- èŠå¤©æ¨¡å¼ï¼šæ›´æ–° Ghost Node æ–‡æœ¬å†…å®¹ï¼ŒåŠ¨æ€ä¼°ç®—é«˜åº¦ï¼Œä¿å­˜èŠ‚ç‚¹
- ç”Ÿå›¾æ¨¡å¼ï¼šæ›´æ–°ä¸ºâ€œğŸ’¾ Saving image...â€ï¼Œä¿å­˜å›¾ç‰‡åˆ° Vaultï¼Œæ›¿æ¢ä¸º File Node
- é”™è¯¯å¤„ç†ï¼šæ›´æ–°ä¸ºé”™è¯¯æ ·å¼ä¸æç¤ºï¼Œä¾¿äºç”¨æˆ·é‡è¯•

```mermaid
flowchart TD
Start(["å¼€å§‹"]) --> CreateGhost["åˆ›å»º Ghost Node"]
CreateGhost --> Mode{"æ¨¡å¼?"}
Mode --> |èŠå¤©| Chat["è°ƒç”¨ API è·å–æ–‡æœ¬"]
Mode --> |ç”Ÿå›¾| Img["è°ƒç”¨ API è·å–å›¾ç‰‡"]
Chat --> UpdateGhost["æ›´æ–° Ghost Node æ–‡æœ¬/é«˜åº¦"]
Img --> SaveImg["ä¿å­˜å›¾ç‰‡åˆ° Vault"]
SaveImg --> ReplaceNode["æ›¿æ¢ä¸º File Node"]
UpdateGhost --> End(["ç»“æŸ"])
ReplaceNode --> End
```

å›¾è¡¨æ¥æº
- [main.ts](file://main.ts#L1246-L1327)
- [main.ts](file://main.ts#L1152-L1244)
- [design_doc.md](file://docs/design_doc.md#L55-L71)

ç« èŠ‚æ¥æº
- [main.ts](file://main.ts#L1152-L1327)
- [design_doc.md](file://docs/design_doc.md#L55-L71)

## ä¾èµ–åˆ†æ
- æ’ä»¶ä¸»ç±»ä¾èµ–ï¼š
  - FloatingPaletteï¼šUI äº¤äº’ä¸çŠ¶æ€ç®¡ç†
  - ApiManagerï¼šAPI è¯·æ±‚å°è£…
  - IntentResolver/CanvasConverterï¼šä¸Šä¸‹æ–‡è§£æä¸è½¬æ¢
  - types.tsï¼šCanvas ç±»å‹å®šä¹‰
- äº‹ä»¶è€¦åˆï¼š
  - é€šè¿‡ workspace äº‹ä»¶ä¸ DOM äº‹ä»¶é©±åŠ¨ UI è¡Œä¸º
  - é€šè¿‡è½®è¯¢é™ä½å»¶è¿Ÿï¼Œæé«˜å¯¹å¿«é€Ÿåˆ‡æ¢çš„å“åº”
- å¤–éƒ¨ä¾èµ–ï¼š
  - Obsidian App/workspace/ItemView/Modal/Notice ç­‰åŸç”Ÿ API
  - requestUrl å‘èµ· HTTP è¯·æ±‚

```mermaid
graph TB
P["CanvasAIPlugin(main.ts)"] --> FP["FloatingPalette(main.ts)"]
P --> AM["ApiManager(api-manager.ts)"]
P --> IR["IntentResolver(intent-resolver.ts)"]
IR --> CC["CanvasConverter(canvas-converter.ts)"]
CC --> T["types.ts"]
```

å›¾è¡¨æ¥æº
- [main.ts](file://main.ts#L914-L1030)
- [intent-resolver.ts](file://intent-resolver.ts#L63-L130)
- [canvas-converter.ts](file://canvas-converter.ts#L1-L120)
- [api-manager.ts](file://api-manager.ts#L71-L142)
- [types.ts](file://types.ts#L21-L119)

ç« èŠ‚æ¥æº
- [main.ts](file://main.ts#L914-L1030)
- [intent-resolver.ts](file://intent-resolver.ts#L63-L130)
- [canvas-converter.ts](file://canvas-converter.ts#L1-L120)
- [api-manager.ts](file://api-manager.ts#L71-L142)
- [types.ts](file://types.ts#L21-L119)

## æ€§èƒ½è€ƒé‡
- é€‰ä¸­æ£€æµ‹è½®è¯¢ï¼šæ¯ 200ms æ£€æŸ¥ä¸€æ¬¡ï¼Œå¹³è¡¡å“åº”é€Ÿåº¦ä¸æ€§èƒ½ï¼›åœ¨é Canvas è§†å›¾æˆ–æ— é€‰ä¸­æ—¶å¯å¿½ç•¥
- å›¾ç‰‡å‹ç¼©ï¼šCanvasConverter å°†å›¾ç‰‡å‹ç¼©ä¸º WebP å¹¶é™åˆ¶å°ºå¯¸ï¼Œå‡å°‘ä¼ è¾“ä¸ API Token æ¶ˆè€—
- å¤šä»»åŠ¡å¹¶å‘ï¼šFloatingPalette ç»´æŠ¤ pendingTaskCountï¼Œæ”¯æŒå¤šä»»åŠ¡å¹¶è¡Œï¼ŒæŒ‰é’®ä¿æŒå¯ç”¨
- DOM æ“ä½œæœ€å°åŒ–ï¼šé¢æ¿ä½ç½®ä¸æ˜¾ç¤ºé€šè¿‡ requestAnimationFrame æ§åˆ¶ï¼Œé¿å…é˜»å¡æ¸²æŸ“
- äº‹ä»¶è§£ç»‘ï¼šonUnload é”€æ¯é¢æ¿ï¼›é”®ç›˜ ESC ä½¿ç”¨æ•è·é˜¶æ®µï¼Œç¡®ä¿ä¼˜å…ˆå¤„ç†

[æœ¬èŠ‚ä¸ºé€šç”¨æŒ‡å¯¼ï¼Œæ— éœ€åˆ—å‡ºç« èŠ‚æ¥æº]

## æ•…éšœæ’æŸ¥æŒ‡å—
- API æœªé…ç½®ï¼šFloatingPalette åœ¨ç”Ÿæˆå‰æ£€æŸ¥ ApiManager.isConfiguredï¼Œè‹¥æœªé…ç½®åˆ™ç»ˆæ­¢
- é€‰ä¸­çŠ¶æ€å¼‚å¸¸ï¼šè‹¥ selectionSize ä¸º 0ï¼Œéœ€ç¡®è®¤æ˜¯å¦ä¸ºèƒŒæ™¯ç‚¹å‡»æˆ– Delete/Backspace å¯¼è‡´çš„æ˜ç¡®å…³é—­æ„å›¾
- é¢æ¿ä¸æ˜¾ç¤ºï¼šæ£€æŸ¥æ˜¯å¦åœ¨ Canvas è§†å›¾ã€æ˜¯å¦æˆåŠŸæ³¨å…¥ AI æŒ‰é’®ã€æ˜¯å¦è¢«å…¶ä»–è§†å›¾é®æŒ¡
- ç”Ÿæˆå¤±è´¥ï¼šæŸ¥çœ‹æ§åˆ¶å°é”™è¯¯æ—¥å¿—ï¼Œç¡®è®¤ç½‘ç»œã€æ¨¡å‹å¯ç”¨æ€§ä¸æƒé™ï¼›é”™è¯¯èŠ‚ç‚¹ä¼šå˜ä¸ºçº¢è‰²å¹¶æç¤ºé‡è¯•
- é¢„è®¾ç®¡ç†ï¼šç¡®è®¤é¢„è®¾é›†åˆæŒ‰æ¨¡å¼åŒºåˆ†å­˜å‚¨ï¼Œä¿å­˜/é‡å‘½å/åˆ é™¤åä¼šæŒä¹…åŒ–åˆ°è®¾ç½®

ç« èŠ‚æ¥æº
- [main.ts](file://main.ts#L778-L801)
- [main.ts](file://main.ts#L1450-L1528)
- [api-manager.ts](file://api-manager.ts#L136-L142)

## ç»“è®º
main.ts ä½œä¸º ObsidianCanvasAI æ’ä»¶çš„æ ¸å¿ƒå…¥å£ï¼Œé€šè¿‡å®Œå–„çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€ç¨³å¥çš„ Canvas é€‰ä¸­çŠ¶æ€æ£€æµ‹ä¸æ‚¬æµ®é¢æ¿æ³¨å…¥ã€æ¸…æ™°çš„ UI äº¤äº’ä¸çŠ¶æ€ç®¡ç†ã€ä»¥åŠä¸ IntentResolver/CanvasConverter/ApiManager çš„ç´§å¯†åä½œï¼Œå®ç°äº†ä»ä¸Šä¸‹æ–‡è§£æåˆ°ä»»åŠ¡æ‰§è¡Œä¸å›å†™çš„å®Œæ•´é—­ç¯ã€‚å€ŸåŠ© â€˜Ghost Nodeâ€™ æ¦‚å¿µï¼Œæ’ä»¶åœ¨ Canvas ä¸Šæä¾›äº†å³æ—¶ã€å¯å›æº¯çš„ä»»åŠ¡åé¦ˆä½“éªŒã€‚å»ºè®®åœ¨åç»­è¿­ä»£ä¸­è¿›ä¸€æ­¥å®Œå–„é”™è¯¯é‡è¯•ä¸å¯è§†åŒ–åé¦ˆï¼Œå¹¶æŒç»­ä¼˜åŒ–ä¸Šä¸‹æ–‡è½¬æ¢ä¸ API è°ƒç”¨çš„æ€§èƒ½ä¸ç¨³å®šæ€§ã€‚

[æœ¬èŠ‚ä¸ºæ€»ç»“æ€§å†…å®¹ï¼Œæ— éœ€åˆ—å‡ºç« èŠ‚æ¥æº]

## é™„å½•

### äº‹ä»¶ç›‘å¬ä¸ DOM æ“ä½œæœ€ä½³å®è·µ
- ä½¿ç”¨ workspace.on('layout-change') ä¸è½®è¯¢ç›¸ç»“åˆï¼Œå…¼é¡¾å®æ—¶æ€§ä¸æ€§èƒ½
- ä½¿ç”¨æ•è·é˜¶æ®µå¤„ç† ESCï¼Œç¡®ä¿ä¼˜å…ˆå…³é—­é¢æ¿
- é€šè¿‡ requestAnimationFrame æ§åˆ¶é¢æ¿æ˜¾ç¤ºï¼Œé¿å…å¸ƒå±€æŠ–åŠ¨
- äº‹ä»¶è§£ç»‘ï¼šonUnload é”€æ¯ DOMï¼Œé”®ç›˜äº‹ä»¶ä½¿ç”¨ register æ³¨é”€

ç« èŠ‚æ¥æº
- [main.ts](file://main.ts#L1353-L1599)
- [main.ts](file://main.ts#L961-L968)

### çŠ¶æ€ç®¡ç†ä¸å†…å­˜æ²»ç†
- é¢æ¿å¯è§æ€§ä¸ä½ç½®çŠ¶æ€ï¼šFloatingPalette å†…éƒ¨ç»´æŠ¤ isVisibleã€currentParentã€position ç­‰çŠ¶æ€
- ä»»åŠ¡è®¡æ•°ï¼špendingTaskCount ä¿è¯å¤šä»»åŠ¡å¹¶å‘ä¸‹çš„ UI ä¸€è‡´æ€§
- å†…å­˜é£é™©ï¼šç¡®ä¿ onUnload é”€æ¯ DOMï¼›é”®ç›˜äº‹ä»¶ä¸è½®è¯¢å®šæ—¶å™¨åœ¨æ’ä»¶å¸è½½æ—¶æ¸…ç†ï¼›é¿å…é—­åŒ…æŒæœ‰é•¿ç”Ÿå‘½å‘¨æœŸå¯¹è±¡

ç« èŠ‚æ¥æº
- [main.ts](file://main.ts#L838-L911)
- [main.ts](file://main.ts#L961-L968)